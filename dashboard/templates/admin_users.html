<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración de usuarios · {{ brand_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: #f5f7fb; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .card-panel { background: #fff; border-radius: 16px; box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08); padding: 1.5rem; }
        .table-wrapper { max-height: 420px; overflow-y: auto; }
        .badge-role { font-size: 0.72rem; text-transform: uppercase; letter-spacing: .02em; }
        .password-text { font-family: "Source Code Pro", Consolas, monospace; font-size: 0.85rem; }
        .password-cell button { padding: 2px 6px; }
        .actions-cell .btn { min-width: 52px; padding: 4px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.55); display: none; align-items: center; justify-content: center; z-index: 1050; }
        .modal-overlay.active { display: flex; }
        .modal-card { background: #fff; border-radius: 16px; width: min(420px, 92vw); box-shadow: 0 16px 48px rgba(15,23,42,0.25); padding: 1.5rem; }
        .modal-card h5 { margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="page-header">
            <div>
                <h1 class="h4 mb-1">Administración de usuarios</h1>
                <p class="text-muted mb-0">Consulta los usuarios registrados y sus roles.</p>
            </div>
            <div class="d-flex gap-2">
                <a href="/admin/users/report" class="btn btn-outline-primary btn-sm" target="_blank">Listado de usuarios</a>
                <button class="btn btn-outline-secondary btn-sm" id="refreshUsersBtn">Refrescar</button>
                <a href="/" class="btn btn-outline-secondary btn-sm">Regresar al inicio</a>
            </div>
        </div>

        <div id="usersAlert" class="alert d-none" role="alert"></div>

        <div class="row g-4">
            <div class="col-12">
                <div class="card-panel table-wrapper">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h2 class="h6 mb-0">Usuarios registrados</h2>
                            <small class="text-muted">Información tomada directamente de la base de datos.</small>
                        </div>
                    </div>
                    <table class="table table-hover align-middle" id="usersTable">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Roles</th>
                                <th>Estado</th>
                                <th>Contraseña</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row g-4 mt-1">
            <div class="col-lg-6">
                <div class="card-panel">
                    <h2 class="h6 mb-2">Detalle del usuario</h2>
                    <p class="text-muted small mb-2">ID: <span data-user-field="user_id">--</span></p>
                    <dl class="row mb-0">
                        <dt class="col-sm-4 text-muted">Usuario</dt>
                        <dd class="col-sm-8" data-user-field="username">--</dd>
                        <dt class="col-sm-4 text-muted">Nombre completo</dt>
                        <dd class="col-sm-8" data-user-field="full_name">--</dd>
                        <dt class="col-sm-4 text-muted">Correo</dt>
                        <dd class="col-sm-8" data-user-field="email">--</dd>
                        <dt class="col-sm-4 text-muted">Roles</dt>
                        <dd class="col-sm-8">
                            <div id="userRoles" class="d-flex flex-wrap gap-1"></div>
                        </dd>
                        <dt class="col-sm-4 text-muted">Estado</dt>
                        <dd class="col-sm-8" data-user-field="is_active">--</dd>
                        <dt class="col-sm-4 text-muted">Creado</dt>
                        <dd class="col-sm-8" data-user-field="created_at">--</dd>
                        <dt class="col-sm-4 text-muted">Actualizado</dt>
                        <dd class="col-sm-8" data-user-field="updated_at">--</dd>
                        <dt class="col-sm-4 text-muted">Hash de contraseña</dt>
                        <dd class="col-sm-8 d-flex align-items-center gap-2">
                            <span class="password-text" id="detailPassword" data-user-field="hashed_password" data-visible="false">--</span>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="detailPasswordToggle" disabled title="Mostrar u ocultar hash">
                                <i class="bi bi-eye"></i>
                            </button>
                        </dd>
                    </dl>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card-panel">
                    <h2 class="h6 mb-2">Actualizar datos del usuario</h2>
                    <p class="text-muted small" id="editUserPlaceholder">Selecciona el ícono para editar un usuario.</p>
                    <form id="editUserForm" method="post" class="row g-3 d-none">
                        <input type="hidden" id="editUsernameHidden" name="username">
                        <div class="col-12">
                            <label class="form-label text-muted">Usuario</label>
                            <div class="form-control-plaintext fw-semibold" id="editUsernameDisplay">--</div>
                        </div>
                        <div class="col-12">
                            <label for="editFullName" class="form-label">Nombre completo</label>
                            <input type="text" class="form-control" id="editFullName" name="full_name" required>
                        </div>
                        <div class="col-12">
                            <label for="editEmail" class="form-label">Correo electrónico</label>
                            <input type="email" class="form-control" id="editEmail" name="email">
                        </div>
                        <div class="col-12">
                            <label for="editPassword" class="form-label">Nueva contraseña (opcional)</label>
                            <input type="password" class="form-control" id="editPassword" name="password" placeholder="Déjalo vacío para no cambiarla">
                        </div>
                        <div class="col-12">
                            <label class="form-label d-block">Roles</label>
                            <div class="d-flex flex-wrap gap-2">
                                {% for role in role_options %}
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="roleOption{{ role.value }}" name="roles" value="{{ role.value }}" data-role-checkbox>
                                    <label class="form-check-label" for="roleOption{{ role.value }}">{{ role.label }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-12 form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editIsActive" name="is_active">
                            <label class="form-check-label" for="editIsActive">Usuario activo</label>
                        </div>
                        <div class="col-12 d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Guardar cambios</button>
                            <button type="button" class="btn btn-outline-secondary" id="cancelEditBtn">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center text-muted small mt-4 mb-3">
        {{ brand_name }} · {{ brand_copyright }}
    </footer>

    <div id="stateModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="stateModalTitle">
        <div class="modal-card">
            <h5 id="stateModalTitle">Cambiar estado del usuario</h5>
            <p class="text-muted small mb-3">Selecciona confirmar para alternar el estado de la cuenta.</p>
            <div class="mb-3">
                <p class="mb-1">Usuario: <strong id="stateModalUsername">--</strong></p>
                <p class="mb-0">Estado actual: <span id="stateModalStatus" class="badge bg-secondary">--</span></p>
            </div>
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-outline-secondary" id="stateModalCancel">Cancelar</button>
                <button type="button" class="btn btn-danger" id="stateModalConfirm">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        window.__USERS_INITIAL__ = {{ users_initial | tojson | safe }};
    </script>
    <script src="/static/js/auth.js"></script>
    <script>
        (function() {
            const API_URL = '/admin/api/users';
            const tableBody = document.querySelector('#usersTable tbody');
            const alertBox = document.getElementById('usersAlert');
            const detailFields = document.querySelectorAll('[data-user-field]');
            const rolesContainer = document.getElementById('userRoles');
            const refreshBtn = document.getElementById('refreshUsersBtn');
            const detailPasswordSpan = document.getElementById('detailPassword');
            const detailPasswordToggle = document.getElementById('detailPasswordToggle');
            const editUserForm = document.getElementById('editUserForm');
            const editUserPlaceholder = document.getElementById('editUserPlaceholder');
            const editUsernameDisplay = document.getElementById('editUsernameDisplay');
            const editUsernameHidden = document.getElementById('editUsernameHidden');
            const editFullNameInput = document.getElementById('editFullName');
            const editEmailInput = document.getElementById('editEmail');
            const editPasswordInput = document.getElementById('editPassword');
            const editRoleCheckboxes = document.querySelectorAll('[data-role-checkbox]');
            const editIsActiveInput = document.getElementById('editIsActive');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const deleteForm = document.createElement('form');
            deleteForm.method = 'post';
            deleteForm.className = 'd-none';
            document.body.appendChild(deleteForm);
            const stateModal = document.getElementById('stateModal');
            const stateModalUsername = document.getElementById('stateModalUsername');
            const stateModalStatus = document.getElementById('stateModalStatus');
            const stateModalCancel = document.getElementById('stateModalCancel');
            const stateModalConfirm = document.getElementById('stateModalConfirm');
            let pendingStateUser = null;
            let users = Array.isArray(window.__USERS_INITIAL__) ? window.__USERS_INITIAL__ : [];
            let selectedId = null;

            function maskPassword(value) {
                if (!value) return '--';
                return '••••••';
            }

            function setAlert(message, type = 'info') {
                if (!message) {
                    alertBox.classList.add('d-none');
                    alertBox.textContent = '';
                    return;
                }
                alertBox.textContent = message;
                alertBox.className = `alert alert-${type}`;
            }

            function formatDate(value) {
                if (!value) return '--';
                try {
                    const d = new Date(value);
                    if (isNaN(d.getTime())) return value;
                    return d.toLocaleString();
                } catch {
                    return value;
                }
            }

            function renderRoles(target, list) {
                target.innerHTML = '';
                if (!list || !list.length) {
                    const span = document.createElement('span');
                    span.className = 'text-muted';
                    span.textContent = 'Sin roles';
                    target.appendChild(span);
                    return;
                }
                list.forEach(role => {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-light text-dark badge-role';
                    badge.textContent = role;
                    target.appendChild(badge);
                });
            }

            function clearDetail() {
                detailFields.forEach(field => field.textContent = '--');
                renderRoles(rolesContainer, []);
                detailPasswordSpan.textContent = '--';
                detailPasswordSpan.dataset.password = '';
                detailPasswordSpan.dataset.visible = 'false';
                detailPasswordToggle.disabled = true;
            }

            function selectRow(id) {
                selectedId = id;
                const rows = tableBody.querySelectorAll('tr[data-user-id]');
                rows.forEach(row => {
                    row.classList.toggle('table-active', Number(row.dataset.userId) === Number(id));
                });
                const user = users.find(u => Number(u.user_id) === Number(id));
                if (!user) {
                    clearDetail();
                    closeEditForm();
                    return;
                }
                detailFields.forEach(field => {
                    const key = field.dataset.userField;
                    if (key === 'is_active') {
                        field.textContent = user.is_active ? 'Activo' : 'Inactivo';
                    } else if (key === 'created_at' || key === 'updated_at') {
                        field.textContent = formatDate(user[key]);
                    } else if (key === 'hashed_password') {
                        detailPasswordSpan.dataset.password = user.hashed_password || '';
                        detailPasswordSpan.dataset.visible = 'false';
                        detailPasswordSpan.textContent = maskPassword(user.hashed_password);
                        detailPasswordToggle.disabled = !user.hashed_password;
                        detailPasswordToggle.innerHTML = '<i class="bi bi-eye"></i>';
                    } else {
                        field.textContent = user[key] || '--';
                    }
                });
                renderRoles(rolesContainer, user.roles);
            }

            function openEditForm(user) {
                editUserPlaceholder.classList.add('d-none');
                editUserForm.classList.remove('d-none');
                editUserForm.action = `/admin/users/${user.username}/edit`;
                editUsernameDisplay.textContent = user.username;
                editUsernameHidden.value = user.username;
                editFullNameInput.value = user.full_name || '';
                editEmailInput.value = user.email || '';
                editPasswordInput.value = '';
                editIsActiveInput.checked = !!user.is_active;
                editRoleCheckboxes.forEach(cb => {
                    cb.checked = Array.isArray(user.roles) ? user.roles.includes(cb.value) : false;
                });
            }

            function closeEditForm() {
                editUserForm.classList.add('d-none');
                editUserPlaceholder.classList.remove('d-none');
                editUserForm.action = '';
                editUsernameDisplay.textContent = '--';
                editUsernameHidden.value = '';
                editFullNameInput.value = '';
                editEmailInput.value = '';
                editPasswordInput.value = '';
                editIsActiveInput.checked = false;
                editRoleCheckboxes.forEach(cb => cb.checked = false);
            }

            function openStateModal(user) {
                pendingStateUser = user;
                stateModalUsername.textContent = user.username;
                stateModalStatus.textContent = user.is_active ? 'Activo' : 'Inactivo';
                stateModalStatus.className = user.is_active
                    ? 'badge bg-success-subtle text-success-emphasis'
                    : 'badge bg-danger-subtle text-danger-emphasis';
                    stateModal.classList.add('active');
            }

            function closeStateModal() {
                pendingStateUser = null;
                stateModal.classList.remove('active');
            }

            function handleDeleteUser(user) {
                if (!user) return;
                openStateModal(user);
            }

            function renderUsers() {
                tableBody.innerHTML = '';
                if (!users.length) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 8;
                    cell.className = 'text-center text-muted py-4';
                    cell.textContent = 'No existen usuarios registrados.';
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                    selectRow(null);
                    return;
                }
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.dataset.userId = user.user_id;
                    row.innerHTML = `
                        <td>${user.user_id}</td>
                        <td>${user.username}</td>
                        <td>${user.full_name || '-'}</td>
                        <td>${user.email || '-'}</td>
                        <td>${(user.roles || []).map(role => `<span class="badge bg-light text-dark badge-role me-1">${role}</span>`).join('') || '<span class="text-muted">-</span>'}</td>
                        <td>${user.is_active ? '<span class="badge bg-success-subtle text-success-emphasis">Activo</span>' : '<span class="badge bg-danger-subtle text-danger-emphasis">Inactivo</span>'}</td>
                        <td>
                            ${user.hashed_password ? `
                            <div class="d-flex align-items-center gap-2 password-cell">
                                <span class="password-text" data-password="${user.hashed_password}" data-visible="false">${maskPassword(user.hashed_password)}</span>
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-password-toggle title="Mostrar u ocultar">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>` : '<span class="text-muted">--</span>'}
                        </td>
                        <td>
                            <div class="d-flex gap-2 actions-cell">
                                <button type="button" class="btn btn-sm btn-outline-primary" data-action="consult" title="Consultar"><i class="bi bi-eye"></i></button>
                                <button type="button" class="btn btn-sm btn-outline-success" data-action="update" title="Actualizar"><i class="bi bi-pencil-square"></i></button>
                                <button type="button" class="btn btn-sm btn-outline-danger d-flex justify-content-center align-items-center" data-action="delete" title="Cambiar estado">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                attachPasswordToggles();
                attachActionHandlers();
                if (selectedId) {
                    selectRow(selectedId);
                } else {
                    clearDetail();
                    closeEditForm();
                }
            }

            function attachPasswordToggles() {
                document.querySelectorAll('[data-password-toggle]').forEach(btn => {
                    btn.onclick = () => {
                        const span = btn.closest('.password-cell').querySelector('.password-text');
                        if (!span) return;
                        const isVisible = span.dataset.visible === 'true';
                        span.dataset.visible = String(!isVisible);
                        span.textContent = !isVisible ? (span.dataset.password || '--') : maskPassword(span.dataset.password);
                        btn.innerHTML = !isVisible ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
                    };
                });
            }

            function attachActionHandlers() {
                tableBody.querySelectorAll('tr[data-user-id]').forEach(row => {
                    const userId = Number(row.dataset.userId);
                    const user = users.find(u => Number(u.user_id) === Number(userId));
                    if (!user) return;
                    row.querySelectorAll('[data-action]').forEach(button => {
                        button.onclick = (event) => {
                            event.preventDefault();
                            const action = button.dataset.action;
                            if (action === 'consult') {
                                selectRow(user.user_id);
                            } else if (action === 'update') {
                                selectRow(user.user_id);
                                openEditForm(user);
                            } else if (action === 'delete') {
                                handleDeleteUser(user);
                            }
                        };
                    });
                });
            }

            detailPasswordToggle.addEventListener('click', () => {
                const isVisible = detailPasswordSpan.dataset.visible === 'true';
                detailPasswordSpan.dataset.visible = String(!isVisible);
                detailPasswordSpan.textContent = !isVisible
                    ? (detailPasswordSpan.dataset.password || '--')
                    : maskPassword(detailPasswordSpan.dataset.password);
                detailPasswordToggle.innerHTML = !isVisible ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
            });

            cancelEditBtn.addEventListener('click', () => {
                closeEditForm();
            });

            stateModalCancel.addEventListener('click', () => {
                closeStateModal();
            });

            stateModalConfirm.addEventListener('click', () => {
                if (!pendingStateUser) return;
                deleteForm.action = `/admin/users/${pendingStateUser.username}/delete`;
                closeStateModal();
                deleteForm.submit();
            });

            stateModal.addEventListener('click', (event) => {
                if (event.target === stateModal) {
                    closeStateModal();
                }
            });

            refreshBtn.addEventListener('click', (event) => {
                event.preventDefault();
                fetchUsers();
            });

            async function fetchUsers() {
                try {
                    setAlert('Actualizando usuarios...', 'info');
                    const response = await fetch(API_URL, { headers: { 'Accept': 'application/json' } });
                    if (!response.ok) throw new Error(`Error ${response.status}`);
                    const data = await response.json();
                    users = Array.isArray(data.items) ? data.items : [];
                    renderUsers();
                    setAlert(`Se cargaron ${users.length} usuarios.`, 'success');
                } catch (error) {
                    console.error(error);
                    setAlert('No fue posible actualizar la lista de usuarios.', 'danger');
                }
            }

            renderUsers();
            fetchUsers();
        })();
    </script>
</body>
</html>
